<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Analyse: VTuberコメント判定・辞典</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
        }
        .vtuber-font {
            font-family: 'DotGothic16', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .loading-spinner {
            border: 3px solid rgba(99, 102, 241, 0.1);
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .result-enter {
            animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-12 text-slate-800">

    <nav class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold vtuber-font tracking-widest flex items-center">
                <i class="fas fa-shield-cat mr-3"></i>V-Analyse <span class="text-[10px] ml-2 opacity-60 font-sans tracking-normal">v1.1</span>
            </h1>
            <button onclick="toggleSettings()" class="bg-indigo-500 hover:bg-indigo-400 p-2 rounded-lg transition px-4 text-sm">
                <i class="fas fa-cog mr-1"></i>設定
            </button>
        </div>
    </nav>

    <main class="container mx-auto px-4 mt-6 max-w-6xl">
        
        <!-- Settings Panel -->
        <section id="settings-panel" class="hidden mb-6 glass-card p-6 rounded-2xl shadow-sm border-l-4 border-indigo-500">
            <h2 class="font-bold mb-4 flex items-center justify-between">
                <span><i class="fas fa-sliders-h mr-2"></i>動作設定</span>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </h2>
            
            <div class="space-y-6">
                <!-- API Connection Mode -->
                <div class="space-y-3">
                    <label class="text-sm font-bold text-gray-600 flex items-center gap-2">
                        <i class="fas fa-plug text-indigo-400"></i>API接続モード
                    </label>
                    <div class="flex gap-4 p-1 bg-slate-100 rounded-lg w-fit">
                        <button onclick="setApiMode('auto')" id="api-mode-auto" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all">自動（内蔵）</button>
                        <button onclick="setApiMode('manual')" id="api-mode-manual" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all">手動（個人）</button>
                    </div>
                </div>

                <!-- Manual API Details -->
                <div id="manual-api-details" class="hidden space-y-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-400 uppercase">Gemini API Key</label>
                        <input type="password" id="custom-api-key" placeholder="AI Studioで取得したキーを入力" class="w-full p-2.5 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-400">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="save-key-to-local" class="accent-indigo-600 w-4 h-4">
                        <label for="save-key-to-local" class="text-sm text-gray-600 cursor-pointer">このブラウザにAPIキーを保存する</label>
                    </div>
                    <button onclick="applyApiKey()" class="w-full bg-indigo-600 text-white text-sm font-bold py-2 rounded-lg hover:bg-indigo-700 transition">キーを適用</button>
                </div>

                <hr class="border-slate-100">

                <!-- Data Options -->
                <div class="space-y-3">
                    <label class="text-sm font-bold text-gray-600 flex items-center gap-2">
                        <i class="fas fa-database text-pink-400"></i>データオプション
                    </label>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="auto-save" checked onchange="toggleAutoSave()" class="accent-pink-600 w-4 h-4">
                        <label for="auto-save" class="text-sm text-gray-600 cursor-pointer font-medium">分析結果を自動で辞典に保存する</label>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Panel: Analyzer -->
            <div class="lg:col-span-8 space-y-6">
                <section class="glass-card p-6 rounded-2xl shadow-sm">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold flex items-center">
                            <i class="fas fa-comment-dots text-indigo-500 mr-2"></i>コメント分析
                        </h2>
                        <div id="status-badge" class="text-[9px] bg-green-100 text-green-600 px-2 py-1 rounded-full font-bold uppercase tracking-tighter text-center min-w-[80px]">READY</div>
                    </div>

                    <!-- 1. 許容度の選択 (3段階) -->
                    <div class="mb-6">
                        <label class="block text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-widest text-center">判定の厳しさ（許容度）</label>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="tolerance" value="strict" class="hidden peer">
                                <div class="p-3 text-center rounded-xl border-2 border-slate-100 peer-checked:border-rose-500 peer-checked:bg-rose-50 transition-all">
                                    <i class="fas fa-crown block text-lg mb-1 text-slate-400 peer-checked:text-rose-500"></i>
                                    <span class="text-xs font-bold text-slate-600">王道・清楚</span>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="tolerance" value="normal" checked class="hidden peer">
                                <div class="p-3 text-center rounded-xl border-2 border-slate-100 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all">
                                    <i class="fas fa-check-circle block text-lg mb-1 text-slate-400 peer-checked:text-indigo-500"></i>
                                    <span class="text-xs font-bold text-slate-600">標準</span>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="tolerance" value="loose" class="hidden peer">
                                <div class="p-3 text-center rounded-xl border-2 border-slate-100 peer-checked:border-amber-500 peer-checked:bg-amber-50 transition-all">
                                    <i class="fas fa-biohazard block text-lg mb-1 text-slate-400 peer-checked:text-amber-500"></i>
                                    <span class="text-xs font-bold text-slate-600">寛容・プロレス</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 2. 性格設定の選択 -->
                    <div class="mb-6">
                        <label class="block text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-widest text-center">配信者の性格・スタイル</label>
                        <div class="flex items-center justify-center gap-4 mb-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="personality-type" id="p-type-preset" value="preset" checked onchange="togglePersonalityInput()" class="accent-indigo-600">
                                <span class="text-xs text-slate-600">定番から選ぶ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="personality-type" id="p-type-custom" value="custom" onchange="togglePersonalityInput()" class="accent-indigo-600">
                                <span class="text-xs text-slate-600">手動入力</span>
                            </label>
                        </div>
                        
                        <div id="personality-preset-wrap">
                            <select id="personality-preset" class="w-full p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-400 appearance-none bg-white">
                                <option value="指定なし">指定なし</option>
                                <option value="清楚系アイドル（全肯定、神聖、品行方正）">清楚系アイドル</option>
                                <option value="姉御肌（サバサバ、面倒見が良い、頼れる）">姉御肌</option>
                                <option value="毒舌・Sキャラ（リスナーを弄る、辛辣なツッコミ）">毒舌・Sキャラ</option>
                                <option value="天然・癒やし系（ほんわか、おっとり、聞き上手）">天然・癒やし系</option>
                                <option value="ガチ恋距離（甘えん坊、リスナーとの距離が近い）">ガチ恋・距離感近め</option>
                                <option value="狂気・カオス（予測不能、ハイテンション、ぶっ飛んでいる）">狂気・カオス</option>
                            </select>
                        </div>
                        <div id="personality-custom-wrap" class="hidden">
                            <input type="text" id="personality-custom" placeholder="例：ツンデレ気味なゲーマー、オタクに厳しいギャル等" class="w-full p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-400">
                        </div>
                    </div>

                    <div class="relative group">
                        <textarea id="comment-input" rows="3" class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none mb-4 transition-all pr-10" placeholder="判定したいコメントを入力..."></textarea>
                        <button onclick="clearInput()" class="absolute right-3 top-3 text-gray-300 hover:text-rose-400 transition" title="入力をクリア">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                    
                    <button id="analyze-btn" onclick="analyzeComment()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
                        <span id="btn-text">AI判定を実行</span>
                        <div id="btn-loader" class="loading-spinner border-t-white hidden"></div>
                    </button>
                </section>

                <div id="result-placeholder" class="text-center py-16 text-gray-400 border-2 border-dashed border-gray-100 rounded-3xl">
                    <i class="fas fa-robot text-5xl mb-4 opacity-10"></i>
                    <p class="text-sm">ここに結果が表示されます</p>
                </div>

                <section id="result-section" class="hidden result-enter glass-card p-6 rounded-2xl shadow-md border-t-8 border-indigo-600">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <span id="res-classification" class="inline-block bg-indigo-600 text-white px-3 py-1 rounded-md text-[10px] font-bold mb-2">分類項目</span>
                            <h2 class="text-xl font-bold">分析レポート</h2>
                        </div>
                        <button id="manual-save-btn" onclick="saveToDictionary()" class="flex items-center gap-2 bg-pink-50 text-pink-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-pink-100 transition">
                            <i class="fas fa-bookmark"></i>辞典に保存
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">YouTubeリスク</div>
                            <div class="flex items-end gap-1">
                                <span class="text-3xl font-black text-slate-700" id="res-risk-score">0</span>
                                <span class="text-slate-400 text-xs mb-1">/ 10</span>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">プロレス適性</div>
                            <div class="flex items-end gap-1">
                                <span class="text-3xl font-black text-slate-700" id="res-culture-score">0</span>
                                <span class="text-slate-400 text-xs mb-1">/ 10</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xs font-bold text-indigo-600 mb-2 flex items-center tracking-widest uppercase">
                                <i class="fas fa-microchip mr-2"></i>分析結果
                            </h3>
                            <p id="res-analysis" class="text-sm text-slate-700 leading-relaxed bg-white p-4 rounded-xl border border-slate-100"></p>
                        </div>
                        <div id="advice-container" class="p-4 rounded-xl">
                            <h3 class="text-xs font-bold mb-2 flex items-center tracking-widest uppercase">
                                <i class="fas fa-lightbulb mr-2"></i>推奨対応
                            </h3>
                            <p id="res-advice" class="text-sm leading-relaxed"></p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Panel: Dictionary -->
            <div class="lg:col-span-4">
                <section class="glass-card p-6 rounded-2xl shadow-sm sticky top-24 border-pink-100 border-t-4">
                    <h2 class="text-lg font-bold mb-4 flex items-center justify-between">
                        <span><i class="fas fa-book text-pink-500 mr-2"></i>キショコメ辞典</span>
                        <span id="dict-count" class="text-[9px] bg-pink-50 text-pink-500 px-2 py-1 rounded-full font-bold">0</span>
                    </h2>
                    <div id="dictionary-list" class="space-y-3 max-h-[calc(100vh-320px)] overflow-y-auto pr-2 custom-scrollbar">
                    </div>
                </section>
            </div>
        </div>
        
        <!-- Footer: Disclaimers -->
        <footer class="mt-12 text-center text-[10px] text-gray-400 leading-relaxed px-4">
            <p>【免責事項】</p>
            <p>本ツールはAI（Google Gemini）による文脈解析の結果を表示するものです。分析内容はあくまで「一つの視点」としての参考情報であり、</p>
            <p>特定の人物の意図を100%保証するものではありません。本ツールの利用によるトラブル等の責任は負いかねますのでご了承ください。</p>
            <p class="mt-2">© 2026 V-Analyse Project</p>
        </footer>
    </main>

    <script>
        // State Management
        // 公開配布用に初期値を 'manual' に変更
        let apiMode = localStorage.getItem('v_analyse_api_mode') || 'manual';
        let lastResult = null;
        let sessionApiKey = ""; 
        let autoSave = localStorage.getItem('v_analyse_auto_save') === 'true';

        window.onload = () => {
            document.getElementById('auto-save').checked = autoSave;
            const savedKey = localStorage.getItem('v_analyse_custom_key');
            if (savedKey) {
                sessionApiKey = savedKey;
                document.getElementById('custom-api-key').value = "********";
                document.getElementById('save-key-to-local').checked = true;
            }
            
            setApiMode(apiMode, true);
            loadDictionary();
        };

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
        }

        function clearInput() {
            document.getElementById('comment-input').value = "";
            document.getElementById('comment-input').focus();
        }

        function togglePersonalityInput() {
            const type = document.querySelector('input[name="personality-type"]:checked').value;
            document.getElementById('personality-preset-wrap').classList.toggle('hidden', type !== 'preset');
            document.getElementById('personality-custom-wrap').classList.toggle('hidden', type !== 'custom');
        }

        function setApiMode(mode, isInit = false) {
            apiMode = mode;
            if (!isInit) localStorage.setItem('v_analyse_api_mode', mode);

            const autoBtn = document.getElementById('api-mode-auto');
            const manualBtn = document.getElementById('api-mode-manual');
            const manualDetails = document.getElementById('manual-api-details');
            const statusBadge = document.getElementById('status-badge');

            if (mode === 'auto') {
                autoBtn.className = "px-4 py-1.5 rounded-md text-xs font-bold bg-white shadow-sm text-indigo-600";
                manualBtn.className = "px-4 py-1.5 rounded-md text-xs font-bold text-gray-500 hover:text-gray-700 transition";
                manualDetails.classList.add('hidden');
                statusBadge.textContent = 'AUTO MODE';
                statusBadge.className = 'text-[9px] bg-green-100 text-green-600 px-2 py-1 rounded-full font-bold uppercase tracking-tighter';
            } else {
                manualBtn.className = "px-4 py-1.5 rounded-md text-xs font-bold bg-white shadow-sm text-indigo-600";
                autoBtn.className = "px-4 py-1.5 rounded-md text-xs font-bold text-gray-500 hover:text-gray-700 transition";
                manualDetails.classList.remove('hidden');
                statusBadge.textContent = 'MANUAL MODE';
                statusBadge.className = 'text-[9px] bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-bold uppercase tracking-tighter';
            }
        }

        function applyApiKey() {
            const keyInput = document.getElementById('custom-api-key').value.trim();
            const shouldSave = document.getElementById('save-key-to-local').checked;

            if (keyInput === "" || keyInput === "********") {
                if (sessionApiKey === "") return alert("キーを入力してください");
            } else {
                sessionApiKey = keyInput;
            }

            if (shouldSave) {
                localStorage.setItem('v_analyse_custom_key', sessionApiKey);
            } else {
                localStorage.removeItem('v_analyse_custom_key');
            }
            alert("APIキーを適用しました");
        }

        function toggleAutoSave() {
            autoSave = document.getElementById('auto-save').checked;
            localStorage.setItem('v_analyse_auto_save', autoSave);
        }

        async function analyzeComment() {
            const text = document.getElementById('comment-input').value.trim();
            if (!text) return;

            const finalApiKey = (apiMode === 'manual') ? sessionApiKey : "";
            if (apiMode === 'manual' && !finalApiKey) {
                toggleSettings();
                return alert('APIキーを設定してください');
            }

            const btn = document.getElementById('analyze-btn');
            const loader = document.getElementById('btn-loader');
            const btnText = document.getElementById('btn-text');
            btn.disabled = true;
            loader.classList.remove('hidden');
            btnText.classList.add('hidden');

            const tolerance = document.querySelector('input[name="tolerance"]:checked').value;
            const pType = document.querySelector('input[name="personality-type"]:checked').value;
            const personality = pType === 'preset' ? document.getElementById('personality-preset').value : document.getElementById('personality-custom').value;

            const toleranceMap = {
                strict: "王道・清楚（不快な表現、イジり、セクハラ、馴れ馴れしい態度は一切許容しない）",
                normal: "標準的（マナーに欠ける表現は指摘するが、ある程度の親しみやすさは許容する）",
                loose: "寛容・プロレス（リスナーとの激しい言い合い、キショコメへの鋭いツッコミを芸風として許容する）"
            };

            const systemPrompt = `あなたはVTuber文化とYouTubeガイドライン、実況者・リスナー間の文脈分析に特化したAIです。
以下の「配信者プロファイル」に基づき、コメントを厳格に分析してJSONで出力してください。

【配信者プロファイル】
1. 判定の厳しさ: ${toleranceMap[tolerance]}
2. 配信者の性格/スタイル: ${personality || '指定なし'}

【出力JSONフォーマット】
{
  "classification": "ラベル",
  "risk_score": 0-10,
  "culture_score": 0-10,
  "analysis": "心理分析",
  "advice": "推奨対応",
  "advice_color": "bg-emerald-50 text-emerald-700 | bg-amber-50 text-amber-700 | bg-rose-50 text-rose-700"
}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `コメント内容: 「${text}」` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                
                lastResult = { 
                    ...result, 
                    text, 
                    timestamp: new Date().toLocaleString(),
                    settings: { tolerance, pType, personality }
                };
                displayResult(lastResult);

                if (autoSave) saveToDictionary(true);
            } catch (error) {
                console.error(error);
                alert('分析に失敗しました。');
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
                btnText.classList.remove('hidden');
            }
        }

        function displayResult(res) {
            document.getElementById('result-placeholder').classList.add('hidden');
            const section = document.getElementById('result-section');
            section.classList.remove('hidden');
            
            document.getElementById('res-classification').textContent = res.classification;
            document.getElementById('res-risk-score').textContent = res.risk_score;
            document.getElementById('res-culture-score').textContent = res.culture_score;
            document.getElementById('res-analysis').textContent = res.analysis;
            
            const adviceCont = document.getElementById('advice-container');
            const adviceText = document.getElementById('res-advice');
            adviceText.textContent = res.advice;
            adviceCont.className = `p-4 rounded-xl ${res.advice_color}`;
            
            document.getElementById('manual-save-btn').style.display = autoSave ? 'none' : 'flex';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        function saveToDictionary(isSilent = false) {
            if (!lastResult) return;
            let dict = JSON.parse(localStorage.getItem('vt_dict_v7') || '[]');
            
            // 重複判定を「コメント + 許容度 + 性格」に緩和
            const isDuplicate = dict.some(d => 
                d.text === lastResult.text && 
                d.settings?.tolerance === lastResult.settings?.tolerance &&
                d.settings?.personality === lastResult.settings?.personality
            );
            
            if (isDuplicate) return;

            dict.unshift(lastResult);
            localStorage.setItem('vt_dict_v7', JSON.stringify(dict));
            loadDictionary();
            if (!isSilent) alert('辞典に保存しました');
        }

        function loadDictionary() {
            const listEl = document.getElementById('dictionary-list');
            const dict = JSON.parse(localStorage.getItem('vt_dict_v7') || '[]');
            document.getElementById('dict-count').textContent = dict.length;
            
            if (dict.length === 0) {
                listEl.innerHTML = '<p class="text-gray-300 text-center py-8 text-[10px] italic">辞典は空です</p>';
                return;
            }

            listEl.innerHTML = dict.map((item, index) => {
                let icon = 'fa-check-circle';
                let color = 'text-indigo-400';
                if(item.settings?.tolerance === 'strict') { icon = 'fa-crown'; color = 'text-rose-400'; }
                if(item.settings?.tolerance === 'loose') { icon = 'fa-biohazard'; color = 'text-amber-500'; }

                return `
                <div onclick="recallEntry(${index})" class="bg-white p-3 rounded-xl border border-slate-100 relative group hover:border-indigo-200 transition shadow-sm cursor-pointer">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <i class="fas ${icon} ${color} text-[8px]"></i>
                            <span class="text-[8px] font-black uppercase px-2 py-0.5 bg-slate-100 text-slate-500 rounded-md">${item.classification}</span>
                        </div>
                        <span class="text-[8px] text-gray-300 font-mono">${item.timestamp}</span>
                    </div>
                    <div class="text-[12px] font-bold text-slate-700 line-clamp-2 pr-4 leading-tight">「${item.text}」</div>
                    <div class="mt-2 flex items-center justify-between">
                         <div class="flex gap-3 text-[9px] font-bold">
                            <span class="text-rose-400">R: ${item.risk_score}</span>
                            <span class="text-indigo-400">C: ${item.culture_score}</span>
                        </div>
                        <span class="text-[8px] text-gray-400 truncate max-w-[100px]">${item.settings?.personality || '設定なし'}</span>
                    </div>
                    <button onclick="event.stopPropagation(); deleteEntry(${index})" class="absolute top-2 right-2 text-gray-200 hover:text-rose-400 opacity-0 group-hover:opacity-100 transition">
                        <i class="fas fa-trash text-[10px]"></i>
                    </button>
                </div>
            `}).join('');
        }

        function recallEntry(index) {
            const dict = JSON.parse(localStorage.getItem('vt_dict_v7') || '[]');
            const item = dict[index];
            if (!item) return;

            // コメント復元
            document.getElementById('comment-input').value = item.text;

            // 許容度復元
            if (item.settings?.tolerance) {
                document.querySelector(`input[name="tolerance"][value="${item.settings.tolerance}"]`).checked = true;
            }

            // 性格設定復元
            if (item.settings?.pType) {
                const typeRadio = document.getElementById(`p-type-${item.settings.pType}`);
                if (typeRadio) typeRadio.checked = true;
                togglePersonalityInput();

                if (item.settings.pType === 'preset') {
                    document.getElementById('personality-preset').value = item.personality || item.settings.personality;
                } else {
                    document.getElementById('personality-custom').value = item.personality || item.settings.personality;
                }
            }

            // 分析結果も表示
            displayResult(item);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteEntry(index) {
            let dict = JSON.parse(localStorage.getItem('vt_dict_v7') || '[]');
            dict.splice(index, 1);
            localStorage.setItem('vt_dict_v7', JSON.stringify(dict));
            loadDictionary();
        }
    </script>
</body>
</html>
